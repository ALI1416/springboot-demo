<!DOCTYPE html>
<html lang="zh-cmn-Hans">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Title</title>
  <script src="js/stomp-1.7.1.js"></script>
</head>

<body>
<div>
  <h3>配置</h3>
  <label for="urlText">URL：</label><input id="urlText" type="text" value="ws://127.0.0.1:8080/ws">
  <br>
  <label for="usernameText">用户名：</label><input id="usernameText" type="text" size="10" value="ali">
  <button id="connectBtn">连接</button>
  <h4>连接错误信息：</h4>
  <textarea id="errorMsg" readonly cols="30" rows="3"></textarea>
</div>
<div>
  <h3>广播形式</h3>
  <input id="broadcastText" type="text">
  <button id="broadcastBtn" disabled>发送</button>
  <h4>广播消息：</h4>
  <textarea id="broadcastMsg" readonly cols="30" rows="3"></textarea>
</div>
<div>
  <h3>广播形式2</h3>
  <input id="broadcast2Text" type="text">
  <button id="broadcast2Btn" disabled>发送</button>
  <h4>广播消息2：</h4>
  <textarea id="broadcast2Msg" readonly cols="30" rows="3"></textarea>
</div>
<div>
  <h3>订阅形式</h3>
  <textarea id="subscribeMsg" readonly cols="30" rows="3"></textarea>
</div>
<div>
  <h3>角色形式</h3>
  <span>发送到用户：</span>
  <input id="userSendUsernameText" type="text" size="10">
  <br>
  <input id="userText" type="text">
  <button id="userBtn" disabled>发送</button>
  <h4>用户消息：</h4>
  <textarea id="userMsg" readonly cols="30" rows="3"></textarea>
</div>
<div>
  <h3>没有处理方法的广播</h3>
  <input id="appText" type="text">
  <button id="appBtn" disabled>发送</button>
  <h4>消息：</h4>
  <textarea id="appMsg" readonly cols="30" rows="3"></textarea>
</div>
</body>
<script>
  const urlText = document.getElementById('urlText')
  const usernameText = document.getElementById('usernameText')
  const connectBtn = document.getElementById('connectBtn')
  const errorMsg = document.getElementById('errorMsg')
  const broadcastText = document.getElementById('broadcastText')
  const broadcastBtn = document.getElementById('broadcastBtn')
  const broadcastMsg = document.getElementById('broadcastMsg')
  const broadcast2Text = document.getElementById('broadcast2Text')
  const broadcast2Btn = document.getElementById('broadcast2Btn')
  const broadcast2Msg = document.getElementById('broadcast2Msg')
  const subscribeMsg = document.getElementById('subscribeMsg')
  const userSendUsernameText = document.getElementById('userSendUsernameText')
  const userText = document.getElementById('userText')
  const userBtn = document.getElementById('userBtn')
  const userMsg = document.getElementById('userMsg')
  const appText = document.getElementById('appText')
  const appBtn = document.getElementById('appBtn')
  const appMsg = document.getElementById('appMsg')
  let stomp

  /**
   * 连接/断开按钮
   */
  connectBtn.addEventListener('click', function () {
    if (stomp === undefined) {
      connectBtn.innerText = '连接中...'
      connectBtn.setAttribute('disabled', 'true')
      connect()
    } else {
      disconnect()
    }
  })

  /**
   * 连接
   */
  function connect() {
    const url = urlText.value
    const headers = {
      username: usernameText.value
    }
    stomp = Stomp.client(url)
    stomp.connect(headers, connectCallback, errorCallback)
  }

  /**
   * 连接成功回调
   */
  function connectCallback() {
    connectStatus(true)
    // 广播
    stomp.subscribe('/topic/broadcast', function (res) {
      broadcastMsg.value = res.body + '\n' + broadcastMsg.value
    })
    // 广播2
    stomp.subscribe('/topic/broadcast2', function (res) {
      broadcast2Msg.value = res.body + '\n' + broadcast2Msg.value
    })
    // 订阅
    stomp.subscribe('/app/subscribe/' + usernameText.value, function (res) {
      subscribeMsg.value = res.body + '\n' + subscribeMsg.value
    })
    // 用户
    stomp.subscribe('/user/queue/one', function (res) {
      userMsg.value = res.body + '\n' + userMsg.value
    })
    // 没有处理方法的广播
    stomp.subscribe('/topic/aaa', function (res) {
      appMsg.value = res.body + '\n' + appMsg.value
    })
  }

  /**
   * 连接错误回调
   */
  function errorCallback(e) {
    connectStatus(false)
    stomp = undefined
    errorMsg.value = e + '\n' + errorMsg.value
  }

  /**
   * 断开
   */
  function disconnect() {
    if (stomp !== undefined) {
      stomp.disconnect()
      stomp = undefined
      connectStatus(false)
    }
  }

  /**
   * 改变连接状态显示
   */
  function connectStatus(status) {
    connectBtn.removeAttribute('disabled')
    broadcastBtn.removeAttribute('disabled')
    if (status) {
      connectBtn.innerText = '断开'
      broadcast2Btn.removeAttribute('disabled')
      userBtn.removeAttribute('disabled')
      appBtn.removeAttribute('disabled')
    } else {
      connectBtn.innerText = '连接'
      broadcastBtn.setAttribute('disabled', 'true')
      broadcast2Btn.setAttribute('disabled', 'true')
      userBtn.setAttribute('disabled', 'true')
      appBtn.setAttribute('disabled', 'true')
    }
  }

  /**
   * 发送广播消息
   */
  broadcastBtn.addEventListener('click', function () {
    stomp.send('/app/broadcast', {}, JSON.stringify({msg: broadcastText.value}))
  })

  /**
   * 发送广播消息2
   */
  broadcast2Btn.addEventListener('click', function () {
    stomp.send('/app/broadcast2', {}, JSON.stringify({msg: broadcast2Text.value}))
  })

  /**
   * 发送用户消息
   */
  userBtn.addEventListener('click', function () {
    stomp.send('/app/one', {}, JSON.stringify({username: userSendUsernameText.value, msg: userText.value}))
  })

  /**
   * 没有处理方法的广播
   */
  appBtn.addEventListener('click', function () {
    stomp.send('/topic/aaa', {}, JSON.stringify({msg: appText.value}))
  })
</script>

</html>