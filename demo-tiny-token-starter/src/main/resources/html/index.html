<!DOCTYPE html>
<html lang="zh-cmn-Hans">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Title</title>
</head>

<body>
<div id="tip"></div>
<label for="id">ID：</label><input id="id" type="text" value="1">
<input id="login" type="button" value="登录">
<input id="unlogin" type="button" value="注销">
<script>
  const url = 'http://127.0.0.1:8080/'
  let token = localStorage['tinytoken']

  let tipDiv = document.getElementById('tip')
  let idText = document.getElementById('id')
  let loginBtn = document.getElementById('login')
  let unloginBtn = document.getElementById('unlogin')

  // 进入页面判断登录状态
  if (typeof token === 'undefined') {
    tipDiv.innerText = '未登录'
  } else {
    getId().then(res => {
      if (typeof res === 'undefined') {
        tipDiv.innerText = '登录已过期'
        localStorage.removeItem('tinytoken')
        token = undefined
      } else {
        tipDiv.innerText = '已登录账号[' + res + '] token[' + token + ']'
      }
    })
  }

  /**
   * 点击登录按钮
   */
  loginBtn.addEventListener('click', () => {
    login(idText.value).then(res => {
      localStorage['tinytoken'] = res
      token = res
      tipDiv.innerText = '登录成功，账号[' + idText.value + '] token[' + res + ']'
    })
  })

  /**
   * 点击注销按钮
   */
  unloginBtn.addEventListener('click', () => {
    unlogin().then(res => {
      if (res === true) {
        tipDiv.innerText = '注销token[' + token + ']成功'
      } else {
        tipDiv.innerText = '注销token[' + token + ']失败'
      }
      localStorage.removeItem('tinytoken')
      token = undefined
    })
  })

  /**
   * 获取登录id
   */
  function getId() {
    return myFetch('getId')
  }

  /**
   * 登录
   */
  function login(id) {
    return myFetch('setToken?id=' + id)
  }

  /**
   * 注销
   */
  function unlogin() {
    return myFetch('deleteByToken')
  }

  function myFetch(path) {
    return fetch(url + path, {
      headers: {
        mode: 'no-cors',
        tinytoken: token
      }
    }).then(res => res.json()).then(json => json.data)
  }
</script>
</body>

</html>